<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checklist Venetto - Sistema de Inspeção Veicular</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @media print {
            body { print-color-adjust: exact; -webkit-print-color-adjust: exact; }
            .print\:hidden { display: none !important; }
        }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect } = React;

        // Ícones
        const Check = ({size = 24}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="20 6 9 17 4 12"/></svg>;
        const X = ({size = 24}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>;
        const Printer = ({size = 24}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg>;
        const Save = ({size = 24}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>;
        const Settings = ({size = 24}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="3"/><path d="M12 1v6m0 6v6m9-9h-6m-6 0H3"/></svg>;
        const Plus = ({size = 24}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>;
        const Trash2 = ({size = 24}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>;
        const Edit2 = ({size = 24}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>;
        const Truck = ({size = 24}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="1" y="3" width="15" height="13"/><polygon points="16 8 20 8 23 11 23 16 16 16 16 8"/><circle cx="5.5" cy="18.5" r="2.5"/><circle cx="18.5" cy="18.5" r="2.5"/></svg>;
        const FileText = ({size = 24}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>;
        const Search = ({size = 24}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>;
        const Calendar = ({size = 24}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>;
        const Filter = ({size = 24}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></svg>;
        const Download = ({size = 24}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>;
        const Eye = ({size = 24}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>;

        // Storage
        window.storage = {
            async get(key) {
                const value = localStorage.getItem(key);
                return value ? { key, value } : null;
            },
            async set(key, value) {
                localStorage.setItem(key, value);
                return { key, value };
            },
            async delete(key) {
                localStorage.removeItem(key);
                return { key, deleted: true };
            },
            async list(prefix) {
                const keys = Object.keys(localStorage).filter(k => k.startsWith(prefix));
                return { keys };
            }
        };

        function App() {
            const [showConfig, setShowConfig] = useState(false);
            const [showVehicleForm, setShowVehicleForm] = useState(false);
            const [showHistory, setShowHistory] = useState(false);
            const [showReports, setShowReports] = useState(false);
            const [editingVehicle, setEditingVehicle] = useState(null);
            const [loading, setLoading] = useState(true);
            const [saving, setSaving] = useState(false);
            const [searchTerm, setSearchTerm] = useState('');
            const [viewingChecklist, setViewingChecklist] = useState(null);
            
            const [reportFilters, setReportFilters] = useState({
                startDate: '', endDate: '', placa: '', motorista: '', categoria: '', status: 'todos'
            });

            const [categories, setCategories] = useState(['MECÂNICA', 'ELÉTRICA', 'PNEUS', 'FLUIDOS', 'SEGURANÇA', 'DOCUMENTAÇÃO']);
            const [newCategory, setNewCategory] = useState('');
            const [vehicles, setVehicles] = useState([]);
            const [newVehicle, setNewVehicle] = useState({ placa: '', motorista: '' });
            const [checklistHistory, setChecklistHistory] = useState([]);
            
            const [formData, setFormData] = useState({
                data: new Date().toISOString().split('T')[0],
                placa: '', condutor: '',
                items: [
                    { numero: 1, categoria: 'MECÂNICA', descricao: 'SETOR DE DIREÇÃO VAZANDO MUITO', status: null },
                    { numero: 2, categoria: 'MECÂNICA', descricao: 'OLHAR OS BEXIGÃO DESCENDO SOZINHO', status: null },
                    { numero: 3, categoria: 'ELÉTRICA', descricao: 'LANTERNAS LATERAL QUEBRADA', status: null },
                    { numero: 4, categoria: 'ELÉTRICA', descricao: 'LUZ DA CABINE SEM FUNCIONAR', status: null },
                    { numero: 5, categoria: 'PNEUS', descricao: 'VERIFICAR PRESSÃO DOS PNEUS', status: null },
                    { numero: 6, categoria: 'PNEUS', descricao: 'VERIFICAR DESGASTE E DANOS', status: null },
                    { numero: 7, categoria: 'FLUIDOS', descricao: 'NÍVEL DE ÓLEO DO MOTOR', status: null },
                    { numero: 8, categoria: 'FLUIDOS', descricao: 'NÍVEL DE ÁGUA DO RADIADOR', status: null },
                    { numero: 9, categoria: 'SEGURANÇA', descricao: 'TRIÂNGULO E EXTINTOR', status: null },
                    { numero: 10, categoria: 'SEGURANÇA', descricao: 'CINTO DE SEGURANÇA', status: null },
                ],
                observacoes: ''
            });

            useEffect(() => { loadAllData(); }, []);

            const loadAllData = async () => {
                setLoading(true);
                try {
                    const categoriesData = await window.storage.get('checklist-categories');
                    if (categoriesData) setCategories(JSON.parse(categoriesData.value));
                    const vehiclesData = await window.storage.get('checklist-vehicles');
                    if (vehiclesData) setVehicles(JSON.parse(vehiclesData.value));
                    await loadHistory();
                } catch (error) {
                    console.error('Erro:', error);
                } finally {
                    setLoading(false);
                }
            };

            const loadHistory = async () => {
                try {
                    const keys = await window.storage.list('checklist-history:');
                    if (keys && keys.keys) {
                        const historyPromises = keys.keys.map(async (key) => {
                            const data = await window.storage.get(key);
                            return data ? JSON.parse(data.value) : null;
                        });
                        const historyData = await Promise.all(historyPromises);
                        setChecklistHistory(historyData.filter(h => h).sort((a, b) => new Date(b.data) - new Date(a.data)));
                    }
                } catch (error) {
                    console.error('Erro:', error);
                }
            };

            const saveCategories = async (newCategories) => {
                setCategories(newCategories);
                await window.storage.set('checklist-categories', JSON.stringify(newCategories));
            };

            const saveVehicles = async (newVehicles) => {
                setVehicles(newVehicles);
                await window.storage.set('checklist-vehicles', JSON.stringify(newVehicles));
            };

            const saveChecklist = async () => {
                if (!formData.placa || !formData.condutor) {
                    alert('Preencha placa e condutor!');
                    return;
                }
                setSaving(true);
                try {
                    const checklistId = `checklist-history:${Date.now()}`;
                    await window.storage.set(checklistId, JSON.stringify({ 
                        id: checklistId, ...formData, savedAt: new Date().toISOString() 
                    }));
                    await loadHistory();
                    alert('✅ Checklist salvo!');
                } finally {
                    setSaving(false);
                }
            };

            const handleItemStatusChange = (index, status) => {
                const newItems = [...formData.items];
                newItems[index].status = status;
                setFormData({ ...formData, items: newItems });
            };

            const addNewItem = () => {
                setFormData({
                    ...formData,
                    items: [...formData.items, { 
                        numero: formData.items.length + 1, categoria: '', descricao: '', status: null 
                    }]
                });
            };

            const removeItem = (index) => {
                const newItems = formData.items.filter((_, i) => i !== index).map((item, i) => ({ 
                    ...item, numero: i + 1 
                }));
                setFormData({ ...formData, items: newItems });
            };

            const addCategory = () => {
                if (newCategory.trim()) {
                    saveCategories([...categories, newCategory.toUpperCase().trim()]);
                    setNewCategory('');
                }
            };

            const removeCategory = (index) => {
                saveCategories(categories.filter((_, i) => i !== index));
            };

            const addVehicle = () => {
                if (newVehicle.placa.trim() && newVehicle.motorista.trim()) {
                    saveVehicles([...vehicles, {
                        id: Date.now(),
                        placa: newVehicle.placa.toUpperCase().trim(),
                        motorista: newVehicle.motorista.toUpperCase().trim()
                    }]);
                    setNewVehicle({ placa: '', motorista: '' });
                    setShowVehicleForm(false);
                }
            };

            const updateVehicle = () => {
                if (editingVehicle?.placa.trim() && editingVehicle?.motorista.trim()) {
                    saveVehicles(vehicles.map(v => 
                        v.id === editingVehicle.id 
                            ? { ...v, placa: editingVehicle.placa.toUpperCase().trim(), motorista: editingVehicle.motorista.toUpperCase().trim() }
                            : v
                    ));
                    setEditingVehicle(null);
                }
            };

            const removeVehicle = (id) => saveVehicles(vehicles.filter(v => v.id !== id));
            const selectVehicle = (v) => setFormData({ ...formData, placa: v.placa, condutor: v.motorista });

            const deleteChecklistFromHistory = async (id) => {
                if (confirm('Excluir?')) {
                    await window.storage.delete(id);
                    await loadHistory();
                }
            };

            const newChecklist = () => {
                setFormData({
                    data: new Date().toISOString().split('T')[0],
                    placa: '', condutor: '',
                    items: [
                        { numero: 1, categoria: 'MECÂNICA', descricao: 'SETOR DE DIREÇÃO VAZANDO MUITO', status: null },
                        { numero: 2, categoria: 'MECÂNICA', descricao: 'OLHAR OS BEXIGÃO DESCENDO SOZINHO', status: null },
                        { numero: 3, categoria: 'ELÉTRICA', descricao: 'LANTERNAS LATERAL QUEBRADA', status: null },
                        { numero: 4, categoria: 'ELÉTRICA', descricao: 'LUZ DA CABINE SEM FUNCIONAR', status: null },
                        { numero: 5, categoria: 'PNEUS', descricao: 'VERIFICAR PRESSÃO DOS PNEUS', status: null },
                        { numero: 6, categoria: 'PNEUS', descricao: 'VERIFICAR DESGASTE E DANOS', status: null },
                        { numero: 7, categoria: 'FLUIDOS', descricao: 'NÍVEL DE ÓLEO DO MOTOR', status: null },
                        { numero: 8, categoria: 'FLUIDOS', descricao: 'NÍVEL DE ÁGUA DO RADIADOR', status: null },
                        { numero: 9, categoria: 'SEGURANÇA', descricao: 'TRIÂNGULO E EXTINTOR', status: null },
                        { numero: 10, categoria: 'SEGURANÇA', descricao: 'CINTO DE SEGURANÇA', status: null },
                    ],
                    observacoes: ''
                });
                setShowHistory(false);
                setShowReports(false);
            };

            const filteredHistory = checklistHistory.filter(item => 
                item.placa.toLowerCase().includes(searchTerm.toLowerCase()) ||
                item.condutor.toLowerCase().includes(searchTerm.toLowerCase())
            );

            const getFilteredChecklists = () => {
                return checklistHistory.filter(item => {
                    if (reportFilters.startDate && new Date(item.data) < new Date(reportFilters.startDate)) return false;
                    if (reportFilters.endDate && new Date(item.data) > new Date(reportFilters.endDate)) return false;
                    if (reportFilters.placa && !item.placa.toLowerCase().includes(reportFilters.placa.toLowerCase())) return false;
                    if (reportFilters.motorista && !item.condutor.toLowerCase().includes(reportFilters.motorista.toLowerCase())) return false;
                    if (reportFilters.categoria && !item.items.some(i => i.categoria === reportFilters.categoria)) return false;
                    if (reportFilters.status !== 'todos') {
                        const hasProblems = item.items.some(i => i.status === 'problema');
                        const allChecked = item.items.every(i => i.status !== null);
                        if (reportFilters.status === 'problemas' && !hasProblems) return false;
                        if (reportFilters.status === 'ok' && hasProblems) return false;
                        if (reportFilters.status === 'pendentes' && allChecked) return false;
                    }
                    return true;
                });
            };

            const exportReportCSV = () => {
                const filtered = getFilteredChecklists();
                let csv = 'Data,Placa,Motorista,Total,OK,Problemas,Status\n';
                filtered.forEach(item => {
                    const ok = item.items.filter(i => i.status === 'ok').length;
                    const prob = item.items.filter(i => i.status === 'problema').length;
                    csv += `${new Date(item.data).toLocaleDateString('pt-BR')},${item.placa},${item.condutor},${item.items.length},${ok},${prob},${prob > 0 ? 'COM PROBLEMAS' : 'OK'}\n`;
                });
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `relatorio-${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
            };

            const getReportStats = () => {
                const filtered = getFilteredChecklists();
                return {
                    totalChecklists: filtered.length,
                    totalProblems: filtered.reduce((sum, item) => sum + item.items.filter(i => i.status === 'problema').length, 0),
                    totalOk: filtered.reduce((sum, item) => sum + item.items.filter(i => i.status === 'ok').length, 0),
                    checklistsWithProblems: filtered.filter(item => item.items.some(i => i.status === 'problema')).length
                };
            };

            if (loading) {
                return (
                    <div className="min-h-screen bg-gray-100 flex items-center justify-center">
                        <div className="text-center">
                            <div className="animate-spin rounded-full h-16 w-16 border-b-4 border-blue-600 mx-auto mb-4"></div>
                            <p className="text-gray-600 font-semibold">Carregando...</p>
                        </div>
                    </div>
                );
            }

            if (viewingChecklist) {
                return (
                    <div className="min-h-screen bg-gray-100 p-4">
                        <div className="max-w-4xl mx-auto bg-white shadow-lg rounded-lg">
                            <div className="bg-gradient-to-r from-blue-600 to-blue-800 text-white p-6">
                                <div className="flex justify-between items-center mb-4">
                                    <div className="flex items-center space-x-4">
                                        <div className="bg-white text-blue-800 w-16 h-16 flex items-center justify-center rounded-lg font-bold text-2xl">GV</div>
                                        <div>
                                            <h1 className="text-2xl font-bold">GRUPO VENETTO</h1>
                                            <p className="text-blue-200 text-sm">Visualização de Checklist</p>
                                        </div>
                                    </div>
                                    <button onClick={() => setViewingChecklist(null)} className="bg-white text-blue-800 px-4 py-2 rounded-lg">Voltar</button>
                                </div>
                                <div className="grid grid-cols-3 gap-4 bg-white text-gray-800 p-4 rounded-lg">
                                    <div>
                                        <label className="block text-sm text-gray-600 mb-1">DATA</label>
                                        <p className="font-bold">{new Date(viewingChecklist.data).toLocaleDateString('pt-BR')}</p>
                                    </div>
                                    <div>
                                        <label className="block text-sm text-gray-600 mb-1">PLACA</label>
                                        <p className="font-bold">{viewingChecklist.placa}</p>
                                    </div>
                                    <div>
                                        <label className="block text-sm text-gray-600 mb-1">CONDUTOR</label>
                                        <p className="font-bold">{viewingChecklist.condutor}</p>
                                    </div>
                                </div>
                            </div>
                            <div className="p-6">
                                <div className="space-y-2">
                                    {viewingChecklist.items.map((item, i) => (
                                        <div key={i} className="border rounded-lg p-4">
                                            <div className="flex items-center gap-4">
                                                <span className="font-bold text-lg text-blue-600 w-8">{item.numero}</span>
                                                <span className="font-bold text-sm bg-gray-100 px-3 py-1 rounded">{item.categoria}</span>
                                                <span className="flex-1">{item.descricao}</span>
                                                <span className={`px-4 py-2 rounded-lg font-semibold ${item.status === 'ok' ? 'bg-green-500 text-white' : item.status === 'problema' ? 'bg-red-500 text-white' : 'bg-gray-300'}`}>
                                                    {item.status === 'ok' ? '✓ OK' : item.status === 'problema' ? '✗ PROBLEMA' : 'NÃO VERIFICADO'}
                                                </span>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                                {viewingChecklist.observacoes && (
                                    <div className="mt-6 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                                        <h3 className="font-bold mb-2">OBSERVAÇÕES:</h3>
                                        <p>{viewingChecklist.observacoes}</p>
                                    </div>
                                )}
                                <button onClick={() => window.print()} className="mt-6 w-full bg-blue-600 text-white py-3 rounded-lg font-semibold flex items-center justify-center gap-2">
                                    <Printer size={20} />
                                    Imprimir
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }

            if (showReports) {
                const filtered = getFilteredChecklists();
                const stats = getReportStats();
                return (
                    <div className="min-h-screen bg-gray-100 p-4">
                        <div className="max-w-6xl mx-auto bg-white shadow-lg rounded-lg">
                            <div className="bg-gradient-to-r from-blue-600 to-blue-800 text-white p-6">
                                <div className="flex justify-between items-center">
                                    <div className="flex items-center space-x-4">
                                        <div className="bg-white text-blue-800 w-16 h-16 flex items-center justify-center rounded-lg font-bold text-2xl">GV</div>
                                        <div>
                                            <h1 className="text-2xl font-bold">RELATÓRIOS DE CHECKLISTS</h1>
                                            <p className="text-blue-200 text-sm">Análise e estatísticas</p>
                                        </div>
                                    </div>
                                    <button onClick={() => setShowReports(false)} className="bg-white text-blue-800 px-4 py-2 rounded-lg">Voltar</button>
                                </div>
                            </div>
                            <div className="p-6 bg-gray-50 border-b">
                                <h3 className="font-bold mb-4 flex items-center gap-2"><Filter size={20} />FILTROS</h3>
                                <div className="grid grid-cols-2 md:grid-cols-3 gap-4">
                                    <div>
                                        <label className="block text-sm font-semibold mb-1">Data Inicial</label>
                                        <input type="date" value={reportFilters.startDate} onChange={(e) => setReportFilters({...reportFilters, startDate: e.target.value})} className="w-full px-3 py-2 border rounded" />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-semibold mb-1">Data Final</label>
                                        <input type="date" value={reportFilters.endDate} onChange={(e) => setReportFilters({...reportFilters, endDate: e.target.value})} className="w-full px-3 py-2 border rounded" />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-semibold mb-1">Placa</label>
                                        <input type="text" value={reportFilters.placa} onChange={(e) => setReportFilters({...reportFilters, placa: e.target.value})} placeholder="QBD-1018" className="w-full px-3 py-2 border rounded uppercase" />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-semibold mb-1">Motorista</label>
                                        <input type="text" value={reportFilters.motorista} onChange={(e) => setReportFilters({...reportFilters, motorista: e.target.value})} className="w-full px-3 py-2 border rounded uppercase" />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-semibold mb-1">Categoria</label>
                                        <select value={reportFilters.categoria} onChange={(e) => setReportFilters({...reportFilters, categoria: e.target.value})} className="w-full px-3 py-2 border rounded">
                                            <option value="">Todas</option>
                                            {categories.map((cat, i) => <option key={i} value={cat}>{cat}</option>)}
                                        </select>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-semibold mb-1">Status</label>
                                        <select value={reportFilters.status} onChange={(e) => setReportFilters({...reportFilters, status: e.target.value})} className="w-full px-3 py-2 border rounded">
                                            <option value="todos">Todos</option>
                                            <option value="ok">Sem Problemas</option>
                                            <option value="problemas">Com Problemas</option>
                                            <option value="pendentes">Pendentes</option>
                                        </select>
                                    </div>
                                </div>
                                <div className="mt-4 flex gap-3">
                                    <button onClick={() => setReportFilters({startDate:'',endDate:'',placa:'',motorista:'',categoria:'',status:'todos'})} className="bg-gray-500
